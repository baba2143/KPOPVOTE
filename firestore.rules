rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function: Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Helper function: Check if user is admin
    function isAdmin() {
      return request.auth != null && request.auth.token.admin == true;
    }

    // Helper function: Check if user owns the document
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    // ========================================
    // Users Collection
    // ========================================
    match /users/{userId} {
      // Users can read and write their own data
      allow read, write: if isAuthenticated() && isOwner(userId);

      // Admins can read all user data
      allow read: if isAdmin();

      // Tasks Subcollection
      match /tasks/{taskId} {
        // Users can read and write their own tasks
        allow read, write: if isAuthenticated() && isOwner(userId);
      }
    }

    // ========================================
    // Community Posts Collection
    // ========================================
    match /communityPosts/{postId} {
      // Anyone authenticated can read posts
      allow read: if isAuthenticated();

      // Anyone authenticated can create posts
      allow create: if isAuthenticated();

      // Only post author can update or delete
      allow update, delete: if isAuthenticated() &&
                               request.auth.uid == resource.data.authorId;

      // Admins can delete any post
      allow delete: if isAdmin();

      // Comments Subcollection
      match /comments/{commentId} {
        allow read: if isAuthenticated();
        allow create: if isAuthenticated();
        allow update, delete: if isAuthenticated() &&
                                 request.auth.uid == resource.data.authorId;
      }
    }

    // ========================================
    // In-App Votes Collection
    // ========================================
    match /inAppVotes/{voteId} {
      // Anyone authenticated can read votes
      allow read: if isAuthenticated();

      // Only admins can create, update, or delete votes
      allow write: if isAdmin();

      // Candidates Subcollection
      match /candidates/{candidateId} {
        allow read: if isAuthenticated();
        allow write: if isAdmin();
      }

      // User Votes Subcollection
      match /userVotes/{userVoteId} {
        allow read: if isAuthenticated();
        allow create: if isAuthenticated();
        // Prevent vote modification/deletion
        allow update, delete: if false;
      }
    }

    // ========================================
    // Admin Collections (Admin only)
    // ========================================
    match /adminLogs/{logId} {
      allow read, write: if isAdmin();
    }

    match /adminActions/{actionId} {
      allow read, write: if isAdmin();
    }

    // ========================================
    // Vote Records Collection
    // ========================================
    match /voteRecords/{recordId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      // Admins can read all records
      allow read, write: if isAdmin();
    }

    // ========================================
    // Idol Masters Collection
    // ========================================
    match /idolMaster/{idolId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }

    match /idolMasters/{idolId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }

    // ========================================
    // External App Masters Collection
    // ========================================
    match /externalAppMaster/{appId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }

    match /externalAppMasters/{appId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }

    // ========================================
    // Community Reports Collection
    // ========================================
    match /communityReports/{reportId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow write: if isAdmin();
    }

    // ========================================
    // Point Transactions Collection
    // ========================================
    match /pointTransactions/{transactionId} {
      allow read: if isAuthenticated() &&
                     (request.auth.uid == resource.data.userId || isAdmin());
      allow write: if isAdmin();
    }

    // ========================================
    // Deleted Posts Collection (Admin only)
    // ========================================
    match /deletedPosts/{postId} {
      allow read, write: if isAdmin();
    }

    // ========================================
    // Posts Collection (Community Posts)
    // ========================================
    match /posts/{postId} {
      // Anyone authenticated can read posts
      allow read: if isAuthenticated();

      // Anyone authenticated can create posts
      allow create: if isAuthenticated() &&
                       request.auth.uid == request.resource.data.userId;

      // Only post author can update or delete
      allow update, delete: if isAuthenticated() &&
                               request.auth.uid == resource.data.userId;

      // Admins can delete any post
      allow delete: if isAdmin();

      // Likes Subcollection
      match /likes/{likeId} {
        allow read: if isAuthenticated();
        allow create: if isAuthenticated() &&
                         request.auth.uid == request.resource.data.userId;
        allow delete: if isAuthenticated() &&
                         request.auth.uid == resource.data.userId;
      }

      // Comments Subcollection
      match /comments/{commentId} {
        allow read: if isAuthenticated();
        allow create: if isAuthenticated() &&
                         request.auth.uid == request.resource.data.userId;
        allow update, delete: if isAuthenticated() &&
                                 request.auth.uid == resource.data.userId;
      }
    }

    // ========================================
    // Follows Collection
    // ========================================
    match /follows/{followId} {
      // Anyone authenticated can read follows
      allow read: if isAuthenticated();

      // Anyone authenticated can create follows
      allow create: if isAuthenticated() &&
                       request.auth.uid == request.resource.data.followerId;

      // Only follower can delete
      allow delete: if isAuthenticated() &&
                       request.auth.uid == resource.data.followerId;
    }

    // ========================================
    // Notifications Collection
    // ========================================
    match /notifications/{notificationId} {
      // Users can only read their own notifications
      allow read: if isAuthenticated() &&
                     request.auth.uid == resource.data.userId;

      // Users can update their own notifications (mark as read)
      allow update: if isAuthenticated() &&
                       request.auth.uid == resource.data.userId;

      // System/Cloud Functions can create notifications
      allow create: if isAuthenticated();

      // Admins can read/delete all notifications
      allow read, delete: if isAdmin();
    }

    // ========================================
    // Vote History Collection
    // ========================================
    match /voteHistory/{historyId} {
      // Users can read their own vote history
      allow read: if isAuthenticated() &&
                     request.auth.uid == resource.data.userId;

      // System/Cloud Functions can create vote history
      allow create: if isAuthenticated();

      // Prevent modification/deletion
      allow update, delete: if false;

      // Admins can read all vote history
      allow read: if isAdmin();
    }
  }
}
