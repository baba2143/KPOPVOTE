# 📋 K-VOTE COLLECTOR タスク管理計画

## プロジェクト概要

**プロジェクト名**: K-VOTE COLLECTOR
**現在フェーズ**: Phase 0 - バックエンド基盤構築
**期間**: 2週間
**目標**: ユーザー認証とMVP核となる「投票タスク登録」の基本API・DB構造確立

---

## 🎯 Phase 0 エピック作成

```bash
/sc:task create "Phase 0: バックエンド基盤構築（2週間）" --epic
```

**目的**: Firebase基盤とMVPコア機能のAPI開発

---

## 📅 Week 1: 基盤構築と認証の確立

### B1.1: Firebase環境設定

```bash
/sc:task create "B1.1: Firebase環境設定" --priority high
```

**内容**:
- Firebaseプロジェクト作成・設定
- Firestoreデータベース初期化
- スキーマ定義（users, tasks, communityPosts, inAppVotes）
- セキュリティルール設定（認証済みユーザーのみアクセス許可）

**成果物**:
- `firestore.rules` - セキュリティルール定義
- `firestore.indexes.json` - インデックス定義
- Firebase Console設定完了

**関連ドキュメント**: `DBスキーマ設計案.txt`

---

### B1.2: ユーザー認証API実装

```bash
/sc:task create "B1.2: ユーザー認証API実装" --priority high
```

**内容**:
- Cloud Functions実装:
  - `POST /auth/register` - 新規ユーザー登録
  - `POST /auth/login` - ログイン認証
- Firebase Authentication連携
- JWTトークン発行・検証

**成果物**:
- `functions/src/auth/register.ts`
- `functions/src/auth/login.ts`
- `functions/src/middleware/authMiddleware.ts`

**テストケース**:
- [ ] 新規登録成功
- [ ] 重複メール登録エラー
- [ ] ログイン成功
- [ ] 不正な認証情報エラー

---

### B1.3: 推し設定API実装

```bash
/sc:task create "B1.3: 推し設定API実装" --priority high
```

**内容**:
- Cloud Functions実装:
  - `POST /user/setBias` - 推しメンバーリスト更新
  - `GET /user/getBias` - 現在の推し設定取得
- `users`コレクションの`myBias`フィールド管理

**成果物**:
- `functions/src/user/setBias.ts`
- `functions/src/user/getBias.ts`

**データ構造**:
```json
{
  "myBias": ["Jimin", "Hyunjin", "Yeji"]
}
```

**テストケース**:
- [ ] 推し設定成功
- [ ] 推し更新成功
- [ ] 推し取得成功
- [ ] 空配列設定エラー

---

## 📅 Week 2: タスク管理APIの確立とOGP処理

### B2.1: タスク登録API（コア）実装

```bash
/sc:task create "B2.1: タスク登録API（コア）実装" --priority high
```

**内容**:
- Cloud Functions実装:
  - `POST /task/register` - 投票タスク登録
- Firestoreへのタスク保存（OGP処理は次フェーズ）
- サブコレクション構造: `users/{uid}/tasks/{taskId}`

**成果物**:
- `functions/src/task/register.ts`

**リクエスト例**:
```json
{
  "originalUrl": "https://example.com/vote",
  "voteName": "MAMA Awards - Artist of the Year",
  "externalAppName": "Mnet Plus App",
  "targetMembers": ["Jimin", "V"],
  "deadline": "2024-12-31T23:59:59Z",
  "userMemo": "毎日投票する"
}
```

**テストケース**:
- [ ] タスク登録成功
- [ ] 必須フィールド欠落エラー
- [ ] 不正なURL形式エラー
- [ ] 過去の締め切り日エラー

---

### B2.2: タスク取得API実装

```bash
/sc:task create "B2.2: タスク取得API実装" --priority high
```

**内容**:
- Cloud Functions実装:
  - `GET /task/getUserTasks` - ユーザーのタスクリスト取得
- ソート機能: `deadline`昇順（デフォルト）
- フィルター機能: `targetMembers`による推しフィルター

**成果物**:
- `functions/src/task/getUserTasks.ts`

**クエリパラメータ**:
```
?sortBy=deadline&order=asc&filterBias=Jimin&includeCompleted=false
```

**レスポンス例**:
```json
{
  "tasks": [
    {
      "taskId": "task123",
      "voteName": "MAMA Awards",
      "deadline": "2024-12-31T23:59:59Z",
      "isCompleted": false,
      "targetMembers": ["Jimin"]
    }
  ]
}
```

**テストケース**:
- [ ] 全タスク取得成功
- [ ] 推しフィルター動作確認
- [ ] 締め切りソート確認
- [ ] 空リスト正常応答

---

### B2.3: OGP取得プロトタイプ開発

```bash
/sc:task create "B2.3: OGP取得プロトタイプ開発" --priority high
```

**内容**:
- Cloud Functions実装:
  - `POST /task/fetchOGP` - 外部URLからOGP情報取得
- Open Graph Protocol解析
  - `og:title` - タイトル取得
  - `og:image` - 画像URL取得
- エラーハンドリングと安定性評価

**成果物**:
- `functions/src/task/fetchOGP.ts`
- `functions/src/utils/ogpParser.ts`

**技術選定**:
- ライブラリ: `cheerio` または `open-graph-scraper`
- タイムアウト: 10秒
- リトライ: 3回

**テストケース**:
- [ ] OGP取得成功（一般的なサイト）
- [ ] OGP取得成功（投票サイト）
- [ ] OGPなしサイトでもエラーにならない
- [ ] タイムアウト処理確認
- [ ] 不正なURL処理確認

**安定性評価項目**:
- [ ] 各投票アプリからの取得成功率
  - IDOL CHAMP
  - Mnet Plus
  - MUBEAT
  - Show Champion
- [ ] レスポンス時間計測（平均 < 3秒）
- [ ] エラー率確認（< 5%）

---

### B2.4: ステータス更新API実装

```bash
/sc:task create "B2.4: ステータス更新API実装" --priority high
```

**内容**:
- Cloud Functions実装:
  - `PATCH /task/updateStatus` - タスク進捗ステータス更新
- `isCompleted`フラグ更新
- `statusNote`更新（`"notVoted"`, `"pointShortage"`, `"completed"`）

**成果物**:
- `functions/src/task/updateStatus.ts`

**リクエスト例**:
```json
{
  "taskId": "task123",
  "isCompleted": true,
  "statusNote": "completed",
  "userMemo": "1日10票投票完了"
}
```

**テストケース**:
- [ ] ステータス更新成功
- [ ] 存在しないタスクIDエラー
- [ ] 不正なステータス値エラー
- [ ] 他人のタスク更新不可確認

---

## 📊 タスク構造の全体像

```
📦 Phase 0: バックエンド基盤構築（2週間）
│
├── 📅 Week 1: 基盤構築と認証の確立
│   ├── ✅ B1.1: Firebase環境設定 (Priority: High)
│   │   └── 成果物: firestore.rules, firestore.indexes.json
│   │
│   ├── ✅ B1.2: ユーザー認証API実装 (Priority: High)
│   │   └── 成果物: auth/register.ts, auth/login.ts
│   │
│   └── ✅ B1.3: 推し設定API実装 (Priority: High)
│       └── 成果物: user/setBias.ts, user/getBias.ts
│
└── 📅 Week 2: タスク管理APIの確立とOGP処理
    ├── ✅ B2.1: タスク登録API（コア）実装 (Priority: High)
    │   └── 成果物: task/register.ts
    │
    ├── ✅ B2.2: タスク取得API実装 (Priority: High)
    │   └── 成果物: task/getUserTasks.ts
    │
    ├── ✅ B2.3: OGP取得プロトタイプ開発 (Priority: High)
    │   └── 成果物: task/fetchOGP.ts, utils/ogpParser.ts
    │
    └── ✅ B2.4: ステータス更新API実装 (Priority: High)
        └── 成果物: task/updateStatus.ts
```

---

## 🔄 進捗管理方法

### タスク一覧確認

```bash
/sc:task list
```

### 特定タスクの更新

```bash
/sc:task update "B1.1"
# ステータス: In Progress / Completed / Blocked
```

### 依存関係

```
B1.1 (Firebase環境設定)
  ↓ 必須
B1.2 (認証API) ← B1.3 (推し設定API)
  ↓ 必須
B2.1 (タスク登録API) → B2.2 (タスク取得API)
  ↓ 並行可能
B2.3 (OGP取得) ← B2.4 (ステータス更新API)
```

### ブロッカー管理

- Firebase環境設定（B1.1）完了前は他タスク着手不可
- OGP取得（B2.3）は独立して実験可能
- タスク登録（B2.1）とタスク取得（B2.2）は依存関係あり

---

## 📝 次のステップ（Week 3以降）

### Phase 0 完了後のタスク

1. **コミュニティAPI実装**
   - 投稿作成・取得・更新・削除
   - いいね機能
   - コメント機能

2. **アプリ内独自投票API実装**
   - 投票作成・取得
   - 投票実行（ポイント消費）
   - 集計機能

3. **Votesタブ（Community/Discover）機能実装** 🆕
   - 投票コレクション管理API
   - コレクション作成・編集・削除
   - コレクション検索・トレンド表示
   - 一括タスク追加機能
   - 詳細は下記C3セクション参照

4. **通知システム実装**
   - Firebase Cloud Messaging設定
   - 締め切り通知トリガー
   - プッシュ通知送信

5. **iOS開発開始（Phase 1）**
   - Swift UIプロジェクト初期化
   - Firebase SDK統合
   - API連携実装

---

## 📦 C3: Votesタブ（Community/Discover）機能 🆕

### C3.1: コレクション管理API・データモデル実装

```bash
/sc:task create "C3.1: コレクション管理API実装" --priority high
```

**内容**:
- **データモデル定義**:
  - `VoteCollection`: コレクション本体
  - `UserCollectionSave`: ユーザーの保存済みコレクション
  - `UserFollow`: フォロー関係

- **Cloud Functions実装**:
  - `GET /api/collections` - コレクション一覧取得（ページネーション）
  - `GET /api/collections/search` - 検索・フィルタリング
  - `GET /api/collections/trending` - トレンドコレクション取得
  - `GET /api/collections/:id` - 詳細取得
  - `POST /api/collections` - 新規作成
  - `PUT /api/collections/:id` - 更新
  - `DELETE /api/collections/:id` - 削除
  - `POST /api/collections/:id/save` - 保存
  - `POST /api/collections/:id/add-to-tasks` - 一括タスク追加

**Firestoreスキーマ**:
```
voteCollections/{collectionId}
  - collectionId: string
  - creatorId: string
  - title: string (50文字以内)
  - description: string (500文字以内)
  - tasks: VoteTaskInCollection[] (最大50個)
  - tags: string[] (最大10個)
  - visibility: 'public' | 'followers' | 'private'
  - likeCount: number
  - saveCount: number
  - viewCount: number
  - createdAt: Timestamp
  - updatedAt: Timestamp
```

**成果物**:
- `functions/src/collection/getCollections.ts`
- `functions/src/collection/getCollectionDetail.ts`
- `functions/src/collection/createCollection.ts`
- `functions/src/collection/updateCollection.ts`
- `functions/src/collection/deleteCollection.ts`
- `functions/src/collection/saveCollection.ts`
- `functions/src/collection/addToTasks.ts`
- `functions/src/collection/searchCollections.ts`
- `functions/src/collection/getTrendingCollections.ts`

**テストケース**:
- [ ] コレクション作成成功
- [ ] タイトル50文字以上でエラー
- [ ] タスク51個以上でエラー
- [ ] 検索機能動作確認
- [ ] トレンド表示確認（いいね・保存数順）
- [ ] 一括タスク追加成功
- [ ] 重複タスク除外確認
- [ ] 公開範囲制御確認

---

### C3.2: iOS Votesタブ実装

```bash
/sc:task create "C3.2: iOS Votesタブ実装" --priority high
```

**内容**:
- **UI実装**:
  - `VotesListView.swift` - コレクション一覧
  - `CollectionDetailView.swift` - コレクション詳細
  - `CreateCollectionView.swift` - コレクション作成
  - `MyCollectionsView.swift` - マイコレクション
  - `CollectionSearchView.swift` - 検索画面

- **ViewModel実装**:
  - `CollectionViewModel.swift` - コレクション管理ロジック

- **Service実装**:
  - `CollectionService.swift` - コレクションAPI連携

**主要機能**:
1. **発見機能**:
   - トレンドコレクション表示
   - 検索（タイトル、タグ、クリエイター）
   - カテゴリ別フィルター

2. **作成機能**:
   - タイトル・説明入力
   - タスク選択（自分のタスクから）
   - タグ選択（最大10個）
   - 公開範囲設定

3. **保存・共有機能**:
   - コレクション保存
   - 一括タスク追加（ワンタップ）
   - 共有リンク生成

**成果物**:
- `Views/Votes/VotesListView.swift`
- `Views/Votes/CollectionDetailView.swift`
- `Views/Votes/CreateCollectionView.swift`
- `Views/Votes/MyCollectionsView.swift`
- `ViewModels/CollectionViewModel.swift`
- `Services/CollectionService.swift`

**テストケース**:
- [ ] コレクション一覧表示確認
- [ ] 検索機能動作確認
- [ ] コレクション作成成功
- [ ] 一括タスク追加動作確認
- [ ] 保存機能動作確認
- [ ] 公開範囲制御UI動作確認

---

## 📚 関連ドキュメント

- `KPOP VOTE.md` - プロジェクト全体概要
- `docs/votes-community-feature-spec.md` - Votesタブ（Community/Discover）機能設計仕様書 🆕
- `DBスキーマ設計案.txt` - Firestoreスキーマ設計
- `初期バックエンド開発指示書.txt` - 本タスク管理計画の元資料
- `アプリUIイメージ.png` - UIデザイン参考
- `README.md` - プロジェクト概要とセットアップ
- `phase1_workflow.md` - Phase 1 iOSアプリ開発ワークフロー

---

## ✅ チェックリスト

### Week 1 完了条件
- [ ] Firebaseプロジェクト設定完了
- [ ] Firestoreセキュリティルール動作確認
- [ ] 認証API動作確認（登録・ログイン）
- [ ] 推し設定API動作確認

### Week 2 完了条件
- [ ] タスク登録API動作確認
- [ ] タスク取得API動作確認（ソート・フィルター含む）
- [ ] OGP取得成功率 > 90%
- [ ] ステータス更新API動作確認

### Phase 0 完了条件
- [ ] 全APIエンドポイント実装完了
- [ ] 全ユニットテスト通過
- [ ] APIドキュメント作成（Postman/OpenAPI）
- [ ] iOS開発チームへのハンドオフ準備完了

### C3 (Votes機能) 完了条件 🆕
- [ ] コレクション管理API実装完了（9エンドポイント）
- [ ] Firestoreコレクションスキーマ実装
- [ ] iOS Votesタブ実装完了（5画面）
- [ ] 一括タスク追加機能動作確認
- [ ] 検索・トレンド機能動作確認
- [ ] 公開範囲制御動作確認

---

**最終更新**: 2025-01-13
**作成者**: Claude Code
**バージョン**: 1.0
